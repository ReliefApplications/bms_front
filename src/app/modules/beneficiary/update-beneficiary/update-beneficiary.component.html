<div class="page-container">
  <div class="container-title">
    <h2 *ngIf='mode=="update"'>{{language.update_beneficiary_title | titlecase}}</h2>
    <h2 *ngIf='mode=="create"'>{{language.add_beneficiary_title | titlecase}}</h2>
  </div>

  <app-placeholder-stepper *ngIf="!household"></app-placeholder-stepper>
  <app-placeholder-panel *ngIf="!household"></app-placeholder-panel>

  <mat-horizontal-stepper (selectionChange)="passHousehold()" #stepper linear *ngIf="!loader && (mode == 'create' || (mode == 'update' && beneficiariesForm[0]))">
    <ng-template matStepperIcon="done">
      <mat-icon>done</mat-icon>
    </ng-template>
      <mat-step [completed]="validStep1">
        <form [formGroup]="mainForm">
          <ng-template class="step" matStepLabel>{{language.add_beneficiary_step1}} </ng-template>
          <div class="container-table">
            <div class="stepInMobile">
              <span class="dot">1</span>
              <span>{{language.add_beneficiary_step1}} </span>
            </div>
            <div class="container-content box-primary">
              <div class="content-table content-table-step1">
                <div class="step1 all-information">
                  <div class="column-container">
                    <h4 class="location">{{ language.location }}</h4>
                    <ng-select [clearable]="false" class="single-select" [multiple]="false" [searchable]="true" [closeOnSelect]="true" placeholder="{{language.adm1 | titlecase}}" formControlName="adm1" (change)='loadDistrict($event)' required>
                      <ng-option *ngFor="let option of household.get('location').getOptions('adm1')" [value]="option.get('id')">
                        {{option.get('name') | titlecase}}
                      </ng-option>
                    </ng-select>
                    <app-hint-error [form]="mainForm" fieldName="adm1" [field]="household.get('location').fields.adm1" [isMatField]="false"></app-hint-error>
                    <ng-select [clearable]="false" class="single-select" [multiple]="false" [searchable]=true [closeOnSelect]="true" placeholder="{{language.adm2 | titlecase}}" formControlName="adm2" (change)='loadCommune($event)'>
                      <ng-option *ngFor="let option of household.get('location').getOptions('adm2')" [value]="option.get('id')">
                        {{option.get('name') | titlecase}}
                      </ng-option>
                    </ng-select>
                    <app-hint-error [form]="mainForm" fieldName="adm2" [field]="household.get('location').fields.adm2" [isMatField]="false"></app-hint-error>
                    <ng-select [clearable]="false" class="single-select" [multiple]="false" [searchable]=true [closeOnSelect]="true" placeholder="{{language.adm3 | titlecase}}" formControlName="adm3" (change)='loadVillage($event)'>
                      <ng-option *ngFor="let option of household.get('location').getOptions('adm3')" [value]="option.get('id')">
                        {{option.get('name') | titlecase}}
                      </ng-option>
                    </ng-select>
                    <app-hint-error [form]="mainForm" fieldName="adm3" [field]="household.get('location').fields.adm3" [isMatField]="false"></app-hint-error>
                    <ng-select [clearable]="false" class="single-select" [multiple]="false" [searchable]=true [closeOnSelect]="true" placeholder="{{language.adm4 | titlecase}}" formControlName="adm4">
                      <ng-option *ngFor="let option of household.get('location').getOptions('adm4')" [value]="option.get('id')">
                        {{option.get('name') | titlecase}}
                      </ng-option>
                    </ng-select>
                    <app-hint-error [form]="mainForm" fieldName="adm4" [field]="household.get('location').fields.adm4" [isMatField]="false"></app-hint-error>
                  </div>
                  <div class="column-container">
                    <h4>{{ language.add_beneficiary_res_address }}</h4>
                    <mat-form-field>
                      <input matInput placeholder="{{language.add_beneficiary_getAddressNumber | titlecase}}" formControlName="addressNumber" required>
                      <app-hint-error [form]="mainForm" fieldName="addressNumber" [field]="household.fields.addressNumber" [isMatField]="true"></app-hint-error>
                    </mat-form-field>
                    <mat-form-field>
                      <input matInput placeholder="{{language.add_beneficiary_getAddressStreet | titlecase}}" formControlName="addressStreet" required>
                      <app-hint-error [form]="mainForm" fieldName="addressStreet" [field]="household.fields.addressStreet" [isMatField]="true"></app-hint-error>
                    </mat-form-field>
                    <mat-form-field>
                      <input matInput placeholder="{{language.add_beneficiary_getAddressPostcode | titlecase}}" formControlName="addressPostcode" required>
                      <app-hint-error [form]="mainForm" fieldName="addressPostcode" [field]="household.fields.addressPostcode" [isMatField]="true"></app-hint-error>
                    </mat-form-field>
                  </div>
                  <div class="column-container">
                      <ng-select [clearable]="false" class="single-select" [multiple]="false" [searchable]="true" [closeOnSelect]="true" placeholder="{{language.add_beneficiary_getOccupation | titlecase}}" formControlName="livelihood">
                        <ng-option *ngFor="let livelihood of household.getOptions('livelihood')" [value]="livelihood.get('id')">
                          {{livelihood.get('name') | titlecase}}
                        </ng-option>
                      </ng-select>
                      <app-hint-error [form]="mainForm" fieldName="livelihood" [field]="household.fields.livelihood" [isMatField]="false"></app-hint-error>
                    <div class="specifics" *ngIf="household.get('countrySpecificAnswers').length">
                      <h4>{{ language.settings_country_specific_options | titlecase }}</h4>
                      <mat-form-field *ngFor="let countrySpecificAnswer of household.get('countrySpecificAnswers')">
                        <input *ngIf="countrySpecificAnswer.get('countrySpecific').get('field') === 'IDPoor'" matInput [type]="countrySpecificAnswer.get('countrySpecific').get('type')" placeholder="IDPoor No." [formControlName]="countrySpecificAnswer.get('countrySpecific').get('field')">
                        <input *ngIf="countrySpecificAnswer.get('countrySpecific').get('field') !== 'IDPoor'" matInput [type]="countrySpecificAnswer.get('countrySpecific').get('type')" [placeholder]="countrySpecificAnswer.get('countrySpecific').get('field') | titlecase" [formControlName]="countrySpecificAnswer.get('countrySpecific').get('field')">
                        <app-hint-error [form]="mainForm" fieldName="countrySpecificAnswer.get('countrySpecific').get('field')" [field]="household.fields.countrySpecificAnswers" [isMatField]="true"></app-hint-error>
                      </mat-form-field>
                    </div>
                  </div>
                  <div class="lign-container textarea-input">
                    <mat-form-field class="area-size">
                      <textarea matInput matTextareaAutosize="true" matAutosizeMinRows="5" matAutosizeMaxRows="5"
                        placeholder="{{language.model_notes | titlecase}}" formControlName="notes"></textarea>
                        <app-hint-error [form]="mainForm" fieldName="notes" [field]="household.fields.notes" [isMatField]="true"></app-hint-error>
                    </mat-form-field>
                  </div>
                  <div class="content-button-footer">
                    <div class="action-buttons">
                      <mat-progress-bar mode="determinate" value="0"></mat-progress-bar>
                      <button mat-raised-button class="button-background-primary" (click)="nextValidation(1)">
                        {{language.next}}
                      </button>
                      <button mat-raised-button class="button-background-primary" *ngIf="mode=='update' && !validationLoading" (click)="submit(); nextValidation(1, true)">{{language.update}}</button>
                    </div>
                  </div>
                </div>
              </div>

            </div>
          </div>
        </form>
      </mat-step>

      <mat-step [completed]="validStep2">
        <ng-template class="step" matStepLabel>{{language.add_beneficiary_step2}}</ng-template>
        <div class="container-table">
          <div class="stepInMobile">
            <span class="dot">2</span>
            <span>{{language.add_beneficiary_step2}}</span>
          </div>
          <div class="container-content box-primary">
            <div class="content-table">
              <div class="step2 head" *ngIf="beneficiariesForm[0]">
                <app-beneficiary-form [form]="beneficiariesForm[0]" [options]="getBeneficiaryOptions()"></app-beneficiary-form>
              </div>
              <div class="content-button-footer">
                <div class="action-buttons">
                  <mat-progress-bar mode="determinate" value="35"></mat-progress-bar>
                  <button mat-button class="button-text-primary" (click)="stepper.previous()">
                    {{language.back}}
                  </button>
                  <button mat-raised-button class="button-background-primary" (click)='nextValidation(2)'>
                    {{language.next}}
                  </button>
                  <button mat-raised-button class="button-background-primary" *ngIf="mode=='update' && !validationLoading"
                    (click)="submit(); nextValidation(2, true)">{{language.update}}</button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </mat-step>

      <mat-step [completed]="validStep3">
        <ng-template class="step" matStepLabel>{{language.add_beneficiary_step3}}</ng-template>
        <div class="container-table">
          <div class="stepInMobile">
            <span class="dot">3</span>
            <span>{{language.add_beneficiary_step3}}</span>
          </div>
          <div class="container-content box-primary">
            <div class="content-table">
              <div class="step3 head" *ngFor="let memberForm of beneficiariesForm, let memberIndex=index">
                <div class="container member" *ngIf="memberIndex>0">
                  <div class="button-container">
                    <div class="member-rank">
                      {{memberIndex}}
                    </div>
                    <button mat-mini-fab color='primary' class='delete' (click)="removeBeneficiary(memberForm)">
                      <mat-icon>delete_outline</mat-icon>
                    </button>
                  </div>
                  <app-beneficiary-form [form]="memberForm" [options]="getBeneficiaryOptions()"></app-beneficiary-form>
                </div>
                <mat-divider *ngIf="memberIndex>0 && memberIndex < beneficiariesForm.length-1"></mat-divider>
              </div>
              <div class="content-button-footer">
                <mat-progress-bar mode="determinate" value="70"></mat-progress-bar>
                <div class="action-buttons">
                  <button mat-stroked-button (click)="addBeneficiary()" class="button-text-accent">
                    <mat-icon>add</mat-icon>
                    {{ language.add }}
                  </button>
                  <button mat-button class="button-text-primary" (click)="stepper.previous()">
                    {{language.back}}
                  </button>
                  <button mat-raised-button class="button-background-primary" (click)="passHousehold(); nextValidation(3)">
                    {{language.next}}
                  </button>
                  <button mat-raised-button class="button-background-primary" *ngIf="mode=='update' && !validationLoading"
                    (click)="submit(); nextValidation(3, true)">
                    {{language.update}}
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </mat-step>

      <mat-step [completed]="step4Complete">
        <ng-template matStepLabel>{{language.summary}}</ng-template>
        <div class="container-table">
          <div class="stepInMobile">
            <span class="dot">4</span>
            <span>{{language.summary}}</span>
          </div>
          <div class="container-content box-primary">
            <div class="content-table">
              <form [formGroup]="mainForm">
                <ng-select class="multiple-select" formControlName="projects" placeholder="{{language.projects | titlecase}}" [multiple]="true"  [closeOnSelect]="false" [searchable]="true" required>
                    <ng-option *ngFor="let option of household.getOptions('projects')" [value]="option.get('id')">
                        {{option.get(household.fields.projects.bindField) | titlecase}}
                    </ng-option>
                </ng-select>
                <app-hint-error [form]="mainForm" fieldName="projects" [field]="household.fields.projects" [isMatField]="false"></app-hint-error>
              </form>
              <div class="summary">
                <h3>{{language.beneficiaries_household_info}}</h3>
                <div class="info-resume">
                  <div class="info-container" *ngIf="mainForm.controls.livelihood.value">
                    <h4 class='summary-title'>{{language.add_beneficiary_getOccupation}}: </h4>
                    <p class="summary-title-value">{{getLivelihood().get('name')}}</p>
                  </div>
                  <div class="info-container" *ngIf="mainForm.controls.addressNumber.value && mainForm.controls.addressPostcode.value && mainForm.controls.addressStreet.value">
                    <h4 class='summary-title'> {{language.beneficiaries_full_address}} </h4>
                    <p class="summary-title-value">
                      {{mainForm.controls.addressNumber.value}}
                      {{mainForm.controls.addressStreet.value}},
                      {{mainForm.controls.addressPostcode.value}}
                    </p>
                  </div>
                  <div class="info-container" *ngIf="mainForm.controls.adm1.value">
                    <h4 class='summary-title'> {{ language.beneficiaries_location }} </h4>
                    <p class="summary-title-value">
                      {{getFullLocation()}}
                    </p>
                  </div>
                </div>
                <h3> {{ language.beneficiaries}}</h3>
                <table mat-table [dataSource]="tableData" class="mat-elevation-z8">
                  <ng-container matColumnDef="givenName">
                    <th mat-header-cell *matHeaderCellDef> {{ language.add_beneficiary_getGivenName | titlecase }} </th>
                    <td mat-cell *matCellDef="let element"> {{ element.controls.givenName.value }} </td>
                  </ng-container>

                  <ng-container matColumnDef=familyName>
                    <th mat-header-cell *matHeaderCellDef> {{ language.add_beneficiary_getFamilyName | titlecase }} </th>
                    <td mat-cell *matCellDef="let element"> {{ element.controls.familyName.value }} </td>
                  </ng-container>

                  <ng-container matColumnDef="gender">
                    <th mat-header-cell *matHeaderCellDef> {{ language.gender |titlecase }} </th>
                    <td mat-cell *matCellDef="let element"> {{ getGender(element.controls.gender.value) | titlecase }} </td>
                  </ng-container>

                  <ng-container matColumnDef="dateOfBirth">
                    <th mat-header-cell *matHeaderCellDef> {{ language.add_beneficiary_getDateOfBirth |titlecase }} </th>
                    <td mat-cell *matCellDef="let element"> {{ element.controls.dateOfBirth.value | date: 'dd-MM-yyyy' }}
                    </td>
                  </ng-container>

                  <ng-container matColumnDef="phone">
                    <th mat-header-cell *matHeaderCellDef> {{ language.phone |titlecase}} </th>
                    <td mat-cell *matCellDef="let element">
                      {{ element.controls.phoneNumber0.value }} {{ element.controls.phoneNumber1.value }}
                    </td>
                  </ng-container>

                  <ng-container matColumnDef="nationalId">
                    <th mat-header-cell *matHeaderCellDef> {{ language.add_beneficiary_nationalID | titlecase }} </th>
                    <td mat-cell *matCellDef="let element"> {{element.controls.IDNumber.value}} </td>
                  </ng-container>

                  <tr mat-header-row *matHeaderRowDef="tableColumns"></tr>
                  <tr mat-row *matRowDef="let row; columns: tableColumns;"></tr>
                </table>
              </div>
              <div class="content-button-footer">
                <mat-progress-bar mode="determinate" value="100"></mat-progress-bar>
                <div class="action-buttons">
                  <button mat-button class="button-text-primary" (click)="leave()">{{language.cancel}}</button>

                  <mat-spinner [diameter]="25" *ngIf="validationLoading"></mat-spinner>
                  <button mat-raised-button class="button-background-primary" *ngIf="mode=='create' && !validationLoading"
                    (click)="submit()">{{language.create}}</button>
                  <button mat-raised-button class="button-background-primary" *ngIf="mode=='update' && !validationLoading"
                    (click)="submit()">{{language.update}}</button>
                </div>
              </div>

            </div>
          </div>
        </div>
      </mat-step>
  </mat-horizontal-stepper>
</div>

<div class="page-container">
  <div class="container-title">
    <h2 *ngIf='mode=="update"'>{{Text.update_beneficiary_title | titlecase}}</h2>
    <h2 *ngIf='mode=="create"'>{{Text.add_beneficiary_title | titlecase}}</h2>
  </div>

  <app-placeholder-stepper *ngIf="!household"></app-placeholder-stepper>
  <app-placeholder-panel *ngIf="!household"></app-placeholder-panel>

  <mat-horizontal-stepper #stepper linear *ngIf="!loader && (mode == 'create' || (mode == 'update' && beneficiaries[0]))">
    <ng-template matStepperIcon="done">
      <mat-icon>done</mat-icon>
    </ng-template>
      <mat-step [completed]="validStep1">
        <form [formGroup]="mainForm">
          <ng-template class="step" matStepLabel>{{Text.add_beneficiary_step1}} </ng-template>
          <div class="container-table">
            <div class="stepInMobile">
              <span class="dot">1</span>
              <span>{{Text.add_beneficiary_step1}} </span>
            </div>
            <div class="container-content box-primary">
              <div class="content-table content-table-step1">
                <div class="step1 all-information">
                  <div class="column-container">
                    <h4 class="location">{{ Text.location }}</h4>
                    <ng-select [clearable]="false" class="single-select" [multiple]="false" [searchable]="true" [closeOnSelect]="true" placeholder={{Text.adm1}} formControlName="adm1" (change)='loadDistrict($event)' required>
                      <ng-option *ngFor="let option of household.fields.location.value.fields.adm1.options" [value]="option.fields.id.value">
                        {{option.fields.name.value | titlecase}}
                      </ng-option>
                    </ng-select>
                    <ng-select [clearable]="false" class="single-select" [multiple]="false" [searchable]=true [closeOnSelect]="true" placeholder={{Text.adm2}} formControlName="adm2" (change)='loadCommune($event)'>
                      <ng-option *ngFor="let option of household.fields.location.value.fields.adm2.options" [value]="option.fields.id.value">
                        {{option.fields.name.value | titlecase}}
                      </ng-option>
                    </ng-select>
                    <ng-select [clearable]="false" class="single-select" [multiple]="false" [searchable]=true [closeOnSelect]="true" placeholder={{Text.adm3}} formControlName="adm3" (change)='loadVillage($event)'>
                      <ng-option *ngFor="let option of household.fields.location.value.fields.adm3.options" [value]="option.fields.id.value">
                        {{option.fields.name.value | titlecase}}
                      </ng-option>
                    </ng-select>
                    <ng-select [clearable]="false" class="single-select" [multiple]="false" [searchable]=true [closeOnSelect]="true" placeholder={{Text.adm4}} formControlName="adm4">
                      <ng-option *ngFor="let option of household.fields.location.value.fields.adm4.options" [value]="option.fields.id.value">
                        {{option.fields.name.value | titlecase}}
                      </ng-option>
                    </ng-select>
                  </div>
                  <div class="column-container">
                    <h4>{{ Text.add_beneficiary_res_address }}</h4>
                    <mat-form-field>
                      <input matInput placeholder={{Text.add_beneficiary_getAddressNumber}} formControlName="addressNumber" required>
                    </mat-form-field>
                    <mat-form-field>
                      <input matInput placeholder={{Text.add_beneficiary_getAddressStreet}} formControlName="addressStreet" required>
                    </mat-form-field>
                    <mat-form-field>
                      <input matInput placeholder={{Text.add_beneficiary_getAddressPostcode}} formControlName="addressPostcode" required>
                    </mat-form-field>
                  </div>
                  <div class="column-container">
                      <ng-select [clearable]="false" class="single-select" [multiple]="false" [searchable]="true" [closeOnSelect]="true" placeholder={{Text.add_beneficiary_getOccupation}} formControlName="livelihood">
                        <ng-option *ngFor="let livelihood of livelihoodsList" [value]="livelihood.id">
                          {{livelihood.name | titlecase}}
                        </ng-option>
                      </ng-select>
                    <div class="specifics" *ngIf="household.fields.countrySpecificAnswers.value.length">
                      <h4>{{ Text.settings_country_specific_options | titlecase }}</h4>
                      <mat-form-field *ngFor="let countrySpecificAnswer of household.fields.countrySpecificAnswers.value">
                        <input *ngIf="countrySpecificAnswer.fields.countrySpecific.value.fields.field.value === 'IDPoor'" matInput [type]="countrySpecificAnswer.fields.countrySpecific.value.fields.type.value" placeholder="IDPoor No." [formControlName]="countrySpecificAnswer.fields.countrySpecific.value.fields.field.value">
                        <input *ngIf="countrySpecificAnswer.fields.countrySpecific.value.fields.field.value !== 'IDPoor'" matInput [type]="countrySpecificAnswer.fields.countrySpecific.value.fields.type.value" placeholder={{countrySpecificAnswer.fields.countrySpecific.value.fields.field.value}} [formControlName]="countrySpecificAnswer.fields.countrySpecific.value.fields.field.value">
                      </mat-form-field>
                    </div>
                  </div>
                  <div class="lign-container textarea-input">
                    <mat-form-field class="area-size">
                      <textarea matInput matTextareaAutosize="true" matAutosizeMinRows="5" matAutosizeMaxRows="5"
                        placeholder={{Text.model_notes}} formControlName="notes"></textarea>
                    </mat-form-field>
                  </div>
                  <div class="content-button-footer">
                    <div class="action-buttons">
                      <mat-progress-bar mode="determinate" value="0"></mat-progress-bar>
                      <button mat-raised-button class="button-background-primary" (click)="nextValidation(1, stepper)">
                        {{Text.next}}
                      </button>
                      <button mat-raised-button class="button-background-primary" *ngIf="mode=='update' && !validationLoading" (click)="submit(); nextValidation(1, stepper, true)">{{Text.update}}</button>
                    </div>
                  </div>
                </div>
              </div>

            </div>
          </div>
        </form>
      </mat-step>

      <mat-step [completed]="validStep2">
        <ng-template class="step" matStepLabel>{{Text.add_beneficiary_step2}}</ng-template>
        <div class="container-table">
          <div class="stepInMobile">
            <span class="dot">2</span>
            <span>{{Text.add_beneficiary_step2}}</span>
          </div>
          <div class="container-content box-primary">
            <div class="content-table">
              <div class="step2 head" *ngIf="beneficiaries[0]">
                <app-beneficiary-form [form]="beneficiariesForm[0]" [beneficiary]="beneficiaries[0]" [vulnerabilityList]="vulnerabilityList" [countryCodesList]="countryCodesList"></app-beneficiary-form>
              </div>
              <div class="content-button-footer">
                <div class="action-buttons">
                  <mat-progress-bar mode="determinate" value="35"></mat-progress-bar>
                  <button mat-button class="button-text-primary" (click)="stepper.previous()">
                    {{Text.back}}
                  </button>
                  <button mat-raised-button class="button-background-primary" (click)='nextValidation(2, stepper)'>
                    {{Text.next}}
                  </button>
                  <button mat-raised-button class="button-background-primary" *ngIf="mode=='update' && !validationLoading"
                    (click)="submit(); nextValidation(2, stepper, true)">{{Text.update}}</button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </mat-step>

      <mat-step [completed]="validStep3">
        <ng-template class="step" matStepLabel>{{Text.add_beneficiary_step3}}</ng-template>
        <div class="container-table">
          <div class="stepInMobile">
            <span class="dot">3</span>
            <span>{{Text.add_beneficiary_step3}}</span>
          </div>
          <div class="container-content box-primary">
            <div class="content-table">
              <div class="step3 head" *ngFor="let member of beneficiaries, let memberIndex=index">
                <div class="container member" *ngIf="memberIndex>0">
                  <div class="button-container">
                    <div class="member-rank">
                      {{memberIndex}}
                    </div>
                    <button mat-mini-fab color='primary' class='delete' (click)="removeBeneficiary(memberIndex)">
                      <mat-icon>delete_outline</mat-icon>
                    </button>
                  </div>
                  <app-beneficiary-form [form]="beneficiariesForm[memberIndex]" [beneficiary]="beneficiaries[memberIndex]" [vulnerabilityList]="vulnerabilityList" [countryCodesList]="countryCodesList"></app-beneficiary-form>
                </div>
                <mat-divider *ngIf="memberIndex>0 && memberIndex < beneficiaries.length-1"></mat-divider>
              </div>
              <div class="content-button-footer">
                <mat-progress-bar mode="determinate" value="70"></mat-progress-bar>
                <div class="action-buttons">
                  <button mat-stroked-button (click)="addBeneficiary()" class="button-text-accent">
                    <mat-icon>add</mat-icon>
                    {{ Text.add }}
                  </button>
                  <button mat-button class="button-text-primary" (click)="stepper.previous()">
                    {{Text.back}}
                  </button>
                  <button mat-raised-button class="button-background-primary" (click)="passHousehold(); nextValidation(3, stepper)">
                    {{Text.next}}
                  </button>
                  <button mat-raised-button class="button-background-primary" *ngIf="mode=='update' && !validationLoading"
                    (click)="submit(); nextValidation(3, stepper, true)">
                    {{Text.update}}
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </mat-step>

      <mat-step [completed]="step4Complete">
        <ng-template matStepLabel>{{Text.summary}}</ng-template>
        <div class="container-table">
          <div class="stepInMobile">
            <span class="dot">4</span>
            <span>{{Text.summary}}</span>
          </div>
          <div class="container-content box-primary">
            <div class="content-table">
              <form [formGroup]="mainForm">
                <ng-select class="multiple-select" formControlName="projects" placeholder="{{Text.projects}}" [multiple]="true"  [closeOnSelect]="false" [searchable]="true" required>
                    <ng-option *ngFor="let option of household.fields.projects.options" [value]="option.fields.id.value">
                        {{option.fields[household.fields.projects.bindField].value | titlecase}}
                    </ng-option>
                </ng-select>
              </form>
              <div class="summary">
                <h3>{{Text.beneficiaries_household_info}}</h3>
                <div class="info-resume">
                  <div class="info-container" *ngIf="mainForm.controls.livelihood.value > 0">
                    <h4 class='summary-title'>{{Text.add_beneficiary_getOccupation}}: </h4>
                    <p class="summary-title-value">{{getLivelihood().name}}</p>
                  </div>
                  <div class="info-container" *ngIf="mainForm.controls.addressNumber.value && mainForm.controls.addressPostcode.value && mainForm.controls.addressStreet.value">
                    <h4 class='summary-title'> {{Text.beneficiaries_full_address}} </h4>
                    <p class="summary-title-value">
                      {{mainForm.controls.addressNumber.value}}
                      {{mainForm.controls.addressStreet.value}},
                      {{mainForm.controls.addressPostcode.value}}
                    </p>
                  </div>
                  <div class="info-container" *ngIf="mainForm.controls.adm1.value">
                    <h4 class='summary-title'> {{ Text.beneficiaries_location }} </h4>
                    <p class="summary-title-value">
                      {{getFullLocation()}}
                    </p>
                  </div>
                </div>
                <h3> {{ Text.beneficiaries}} : </h3>
                <table mat-table [dataSource]="tableData" class="mat-elevation-z8 summary">
                  <ng-container matColumnDef="givenName">
                    <th mat-header-cell *matHeaderCellDef> {{ Text.add_beneficiary_getGivenName | titlecase }} </th>
                    <td mat-cell *matCellDef="let element"> {{ element.controls.givenName.value }} </td>
                  </ng-container>

                  <ng-container matColumnDef=familyName>
                    <th mat-header-cell *matHeaderCellDef> {{ Text.add_beneficiary_getFamilyName | titlecase }} </th>
                    <td mat-cell *matCellDef="let element"> {{ element.controls.familyName.value }} </td>
                  </ng-container>

                  <ng-container matColumnDef="gender">
                    <th mat-header-cell *matHeaderCellDef> {{ Text.gender |titlecase }} </th>
                    <td mat-cell *matCellDef="let element"> {{ getGender(element.controls.gender.value) | titlecase }} </td>
                  </ng-container>

                  <ng-container matColumnDef="dateOfBirth">
                    <th mat-header-cell *matHeaderCellDef> {{ Text.add_beneficiary_getDateOfBirth |titlecase }} </th>
                    <td mat-cell *matCellDef="let element"> {{ this.formatDate(element.controls.dateOfBirth.value) }}
                    </td>
                  </ng-container>

                  <ng-container matColumnDef="phone">
                    <th mat-header-cell *matHeaderCellDef> {{ Text.phone |titlecase}} </th>
                    <td mat-cell *matCellDef="let element">
                      {{ element.controls.phoneNumber0.value }} {{ element.controls.phoneNumber1.value }}
                    </td>
                  </ng-container>

                  <ng-container matColumnDef="nationalId">
                    <th mat-header-cell *matHeaderCellDef> {{ Text.add_beneficiary_nationalID | titlecase }} </th>
                    <td mat-cell *matCellDef="let element"> {{element.controls.IDNumber.value}} </td>
                  </ng-container>

                  <tr mat-header-row *matHeaderRowDef="tableColumns"></tr>
                  <tr mat-row *matRowDef="let row; columns: tableColumns;"></tr>
                </table>
              </div>
              <div class="content-button-footer">
                <mat-progress-bar mode="determinate" value="100"></mat-progress-bar>
                <div class="action-buttons">
                  <button mat-button class="button-text-primary" (click)="leave()">{{Text.cancel}}</button>

                  <mat-spinner [diameter]="25" *ngIf="validationLoading"></mat-spinner>
                  <button mat-raised-button class="button-background-primary" *ngIf="mode=='create' && !validationLoading"
                    (click)="submit()">{{Text.create}}</button>
                  <button mat-raised-button class="button-background-primary" *ngIf="mode=='update' && !validationLoading"
                    (click)="submit()">{{Text.update}}</button>
                </div>
              </div>

            </div>
          </div>
        </div>
      </mat-step>
  </mat-horizontal-stepper>
</div>

<div class="page-container">

    <div class="title">
        <h2> {{TEXT.model_distribution | titlecase}} </h2>
        <app-placeholder-title *ngIf="loadingDistribution"> </app-placeholder-title>
        <p *ngIf="actualDistribution && !loadingDistribution">
            {{actualDistribution.name | uppercase}}
            <mat-icon class="valid" *ngIf="actualDistribution.validated==true">lock</mat-icon>
            <mat-icon class="unvalid" *ngIf="actualDistribution.validated==false">lock_open</mat-icon>
            <mat-icon class="valid" *ngIf="actualDistribution.validated==true && !loadingTransaction && getAmount('people')==0">done</mat-icon>
        </p>
    </div>

    <app-placeholder-stepper *ngIf="loadingDatas"></app-placeholder-stepper>

    <mat-horizontal-stepper #myStepper *ngIf="!loadingDatas && !actualDistribution.validated">

        <mat-step label="{{ TEXT.distribution_details_export | uppercase }}" [stepControl]="form1">
            <form [formGroup]="form1">

                <div class="container-table">
                    <div class="container-content">
                      <app-box-properties *ngIf="actualDistribution && initialBeneficiaryData" class="properties-displayed" [entity]="distributionEntity"
                      [mapperService]="mapperService" [componentDisplayed]="actualDistribution" [data]="initialBeneficiaryData.data"></app-box-properties>
                        <div class="content-button">
                            <div class="action-buttons">
                                <button mat-raised-button class="export-button" (click)="export()" *ngIf="!loadingExport">
                                    <mat-icon>get_app</mat-icon>
                                    <span>{{TEXT.beneficiaries_export | uppercase}}</span>
                                </button>
                                <mat-spinner [diameter]='25' *ngIf="loadingExport"></mat-spinner>
                                <div class="extension" *ngIf="!loadingExport">
                                    <div mat-button class="dropdown" [matMenuTriggerFor]="exportType1">
                                        <mat-icon>keyboard_arrow_down</mat-icon>
                                    </div>
                                    <mat-menu #exportType1 class="extMenu">
                                        <button mat-menu-item (click)="setType(1, 'xls')"> .xls <mat-icon *ngIf="extensionTypeStep1=='xls'">done</mat-icon>
                                        </button>
                                        <button mat-menu-item (click)="setType(1, 'csv')"> .csv <mat-icon *ngIf="extensionTypeStep1=='csv'">done</mat-icon>
                                        </button>
                                        <button mat-menu-item (click)="setType(1, 'ods')"> .ods <mat-icon *ngIf="extensionTypeStep1=='ods'">done</mat-icon>
                                        </button>
                                    </mat-menu>
                                </div>
                            </div>
                        </div>
                        <div class="content-table">
                            <div class="waitingDataContainer" *ngIf="loadingFirstStep">
                                <mat-spinner></mat-spinner>
                            </div>
                            <app-table-search *ngIf="widthScreen > maxWidthMobile && !loadingFirstStep" [entity]="beneficiaryEntity"
                                [service]="beneficiariesService" [data]="initialBeneficiaryData" [editable]="!actualDistribution.validated"
                                [parentId]="distributionId">
                            </app-table-search>
                            <app-table-mobile-search *ngIf="widthScreen < maxWidthMobile && !loadingFirstStep" [entity]="beneficiaryEntity"
                                [service]="beneficiariesService" [data]="initialBeneficiaryData" [editable]="!actualDistribution.validated"
                                [parentId]="distributionId">
                            </app-table-mobile-search>
                        </div>
                        <div class="content-button content-button-footer">
                            <button mat-raised-button class="button-background-primary" matStepperNext (click)="this.getDistributionBeneficiaries('both')">Next</button>
                        </div>
                    </div>
                </div>
                <div [ngClass]="{'add-buttons': language != 'ar', 'add-buttons-arabic': language == 'ar'}">
                    <button mat-fab class="add-button" *ngIf="hasRights" (click)="getProjectBeneficiaries(); openDialog(addBeneficiary)"
                        [disabled]="actualDistribution.validated">
                        <mat-icon>add</mat-icon>
                    </button>
                </div>
            </form>
        </mat-step>

        <mat-step label="{{ TEXT.distribution_details_import | uppercase }}" [stepControl]="form2">
            <form [formGroup]="form2">

                <div class="container-table">
                    <div class="container-content">
                        <app-box-properties *ngIf="actualDistribution && initialBeneficiaryData" class="properties-displayed" [entity]="distributionEntity"
                            [mapperService]="mapperService" [componentDisplayed]="actualDistribution" [data]="initialBeneficiaryData.data"></app-box-properties>
                        <div class="import-content">
                            <app-import-distribution *ngIf="!actualDistribution.validated" [distribution]="this.actualDistribution" [rights]="hasRights"
                                (success)=" this.getDistributionBeneficiaries('final');
                                            this.getDistributionBeneficiaries('initial');
                                            jumpStep(myStepper)">
                            </app-import-distribution>
                        </div>
                        <div class="container-empty" *ngIf="actualDistribution.validated">
                            <p>
                                <mat-icon>folder</mat-icon>
                                You can't update this distribution.
                            </p>
                        </div>
                        <div class="content-button content-button-footer">
                            <button mat-raised-button class="button-background-primary" matStepperNext>Next</button>
                        </div>
                    </div>
                </div>

            </form>
        </mat-step>

        <mat-step label="{{ TEXT.distribution_details_random | uppercase }}" [stepControl]="form3">
            <form [formGroup]="form3">

                <div class="container-table">
                    <div class="container-content">
                        <div class="content-button">
                            <div class="sample-size-input">
                                <button mat-fab class="button-background-accent" (click)="generateRandom()">
                                    <mat-icon>shuffle</mat-icon>
                                </button>
                                <mat-form-field>
                                    {{TEXT.sample_choose_size | uppercase}} :
                                    <input matInput [(ngModel)]="this.sampleSize" [ngModelOptions]="{standalone: true}"
                                        min="0" max="100" type="number">
                                    %
                                </mat-form-field>
                            </div>
                            <div class="action-buttons">
                                <button mat-raised-button class="export-button" (click)="exportSample()" *ngIf="!loadingExport">
                                    <mat-icon>get_app</mat-icon>
                                    <span>{{TEXT.beneficiaries_export | uppercase}}</span>
                                </button>
                                <mat-spinner [diameter]='25' *ngIf="loadingExport"></mat-spinner>
                                <div class="extension">
                                    <div mat-button class="dropdown" *ngIf="!loadingExport" [matMenuTriggerFor]="exportType3">
                                        <mat-icon>keyboard_arrow_down</mat-icon>
                                    </div>
                                    <mat-menu #exportType3>
                                        <button mat-menu-item (click)="setType(3, 'xls')"> .xls <mat-icon *ngIf="extensionTypeStep3=='xls'">done</mat-icon>
                                        </button>
                                        <button mat-menu-item (click)="setType(3, 'csv')"> .csv <mat-icon *ngIf="extensionTypeStep3=='csv'">done</mat-icon>
                                        </button>
                                        <button mat-menu-item (click)="setType(3, 'ods')"> .ods <mat-icon *ngIf="extensionTypeStep3=='ods'">done</mat-icon>
                                        </button>
                                    </mat-menu>
                                </div>
                            </div>
                        </div>
                        <div class="container-empty" *ngIf="!randomSampleData && !loadingThirdStep">
                            <p>
                                <mat-icon>clear</mat-icon>
                                Random sample can't be generated...
                            </p>
                        </div>
                        <div class="waitingDataContainer" *ngIf="loadingThirdStep">
                            <mat-spinner></mat-spinner>
                        </div>
                        <div class="content-table" *ngIf="randomSampleData">
                            <app-table-search *ngIf="widthScreen > maxWidthMobile && !loadingThirdStep" [entity]="beneficiaryEntity"
                                [service]="beneficiariesService" [data]="randomSampleData" [parentId]="distributionId">
                            </app-table-search>
                            <app-table-mobile-search *ngIf="widthScreen < maxWidthMobile" [entity]="beneficiaryEntity"
                                [service]="beneficiariesService" [data]="randomSampleData" [parentId]="distributionId">
                            </app-table-mobile-search>
                        </div>
                        <div class="content-button content-button-footer">
                            <button mat-raised-button class="button-background-primary" matStepperNext>Next</button>
                        </div>
                    </div>
                </div>

            </form>
        </mat-step>

        <mat-step label="{{ TEXT.distribution_details_validate | uppercase }}" [stepControl]="form4">
            <form [formGroup]="form4">

                <div class="container-table">
                    <div class="container-content">
                        <div class="content-button">
                            <app-box-properties *ngIf="actualDistribution && finalBeneficiaryData" class="properties-displayed" [entity]="distributionEntity"
                                [mapperService]="mapperService" [componentDisplayed]="actualDistribution" [data]="finalBeneficiaryData.data"></app-box-properties>
                        </div>
                        <div class="container-empty" *ngIf="!finalBeneficiaryData && !loadingFinalStep">
                            <p>
                                <mat-icon>edit</mat-icon>
                                This distribution has not been modified so far.
                            </p>
                            <button mat-raised-button class="button-background-primary" (click)="getDistributionBeneficiaries('final')">
                                Show data anyway </button>
                        </div>
                        <div class="waitingDataContainer" *ngIf="loadingFinalStep">
                            <mat-spinner></mat-spinner>
                        </div>
                        <div class="content-table" *ngIf="finalBeneficiaryData">
                            <app-table-search *ngIf="widthScreen > maxWidthMobile && !loadingFinalStep" [entity]="beneficiaryEntity"
                                [service]="beneficiariesService" [data]="finalBeneficiaryData" [editable]="!actualDistribution.validated"
                                [parentId]="distributionId">
                            </app-table-search>
                            <app-table-mobile-search *ngIf="widthScreen < maxWidthMobile && !loadingFinalStep" [entity]="beneficiaryEntity"
                                [service]="beneficiariesService" [data]="finalBeneficiaryData" [editable]="!actualDistribution.validated"
                                [parentId]="distributionId">
                            </app-table-mobile-search>
                        </div>
                        <div class="content-button content-button-footer">
                            <button mat-raised-button class="button-background-accent" (click)="openDialog(validation)" [disabled]="actualDistribution.validated">
                                <mat-icon >lock</mat-icon>
                                 Validate
                            </button>
                        </div>
                    </div>
                </div>

            </form>
        </mat-step>
    </mat-horizontal-stepper>

    <div class="container-table" *ngIf="actualDistribution.validated && !loadingDatas">
        <div class="container-content">
            <div class="content-button">
                <app-box-properties *ngIf="actualDistribution" class="properties-displayed" [entity]="distributionEntity"
                    [mapperService]="mapperService" [componentDisplayed]="actualDistribution"></app-box-properties>
            </div>
            <div class="progression">
                <div class="commodities" *ngFor="let commodity of actualDistribution.commodities">
                    <h4>{{commodity.modality_type.name}} commodity distribution progress : {{getAmount('ratio', commodity)}} % </h4>
                    <mat-progress-bar mode="determinate" [value]="getAmount('ratio', commodity)"></mat-progress-bar>
                    <div class="details">
                        <div class="info_1">
                            <h5>{{TEXT.transaction_amount_total | uppercase}}</h5>
                            {{ getAmount('total', commodity) }} {{commodity.unit}}
                        </div>
                        <div class="info_2">
                            <h5>{{TEXT.transaction_amount_done | uppercase}}</h5>
                            {{ getAmount('done', commodity) }} {{commodity.unit}}
                        </div>
                        <div class="info_3">
                            <h5>{{TEXT.transaction_amount_waiting | uppercase}}</h5>
                            {{ getAmount('waiting', commodity) }} {{commodity.unit}}
                        </div>
                    </div>
                </div>
            </div>
            <div class="content-button">
                    <div class="action-buttons">
                        <button mat-raised-button class="export-button" (click)="refreshStatuses()">
                            <mat-icon>refresh</mat-icon>
                            <span>Refresh transaction statuses</span>
                        </button>
                    </div>
                </div>
            <div class="waitingDataContainer" *ngIf="loadingTransaction">
                <mat-spinner></mat-spinner>
            </div>
            <div class="content-table" *ngIf="!loadingTransaction">
                <app-transaction-table *ngIf="widthScreen > maxWidthMobile" [parentObject]="actualDistribution" [entity]="transactionBeneficiaryEntity"
                    [service]="BeneficiariesService" [data]="transactionData" [editable]="false" >
                </app-transaction-table>
                <app-transaction-table-mobile *ngIf="widthScreen < maxWidthMobile" [parentObject]="actualDistribution" [entity]="transactionBeneficiaryEntity"
                    [service]="BeneficiariesService" [data]="transactionData" [editable]="false" >
                </app-transaction-table-mobile>
            </div>
            <div class="content-button content-button-footer">
                <mat-spinner [diameter]="35" *ngIf="transacting"></mat-spinner>
                <button mat-raised-button *ngIf="hasRightsTransaction && !transacting"  (click)="openDialog(transaction); codeVerif();"
                class="button-background-accent" [matBadge]="getAmount('people')" matBadgePosition="before" matBadgeColor="primary">
                    <mat-icon>send</mat-icon> Transaction
                </button>
            </div>
        </div>
    </div>

</div>

<ng-template #transaction>
    <mat-dialog-content class="modal-container">
        <h4 class="modal-title underline-accent">Confirm the transaction</h4>
        <div class="dialog-template">
            <div class="modal-body" *ngIf="!chartAccepted">
                <p> {{TEXT.transaction_prevention}}</p>
                <div class="lign-container">
                    <mat-checkbox [(ngModel)]="chartAccepted"></mat-checkbox>
                    <span> {{TEXT.transaction_agree_prevention}} </span>
                </div>
            </div>
            <div class="modal-body" *ngIf="chartAccepted">
                <p> An email containing your validation code has been sent to : {{actualUser.email | uppercase}}. </p>
                <p> Please paste the code here and click on 'Confirm' to proceed with the transaction : </p>
                <br/>
                <div class="lign-container">
                    <mat-form-field>
                        <input matInput placeholder="Code" [(ngModel)]="enteredCode">
                    </mat-form-field>
                    <button mat-stroked-button class='button-text-primary sendCode-button' (click)='codeVerif()'>Send again</button>
                </div>
                <br/>
            </div>
            <div class="modal-footer action">
                <button mat-button class="cancel" (click)="exit('Transaction canceled')">Cancel</button>
                <button mat-button class="confirm" [ngClass]="{'disabled': enteredCode.length<6}" (click)="confirmTransaction()" *ngIf="chartAccepted">Confirm</button>
            </div>
        </div>
    </mat-dialog-content>
</ng-template>

<ng-template #validation>
    <mat-dialog-content class="modal-container">
        <h4 class="modal-title underline-accent" >Confirm the validation</h4>
        <div class="dialog-template">
            <div class="modal-body">
                <p> Do you really want to validate this distribution ? You won't be able to modify it anymore. </p>
            </div>
            <div class="modal-footer action">
                <button mat-button class="cancel" (click)="exit('Validation canceled')">Cancel</button>
                <button mat-button class="confirm" (click)="confirmValidation()">Confirm</button>
            </div>
        </div>
    </mat-dialog-content>
</ng-template>

<ng-template #addBeneficiary>
    <mat-dialog-content class="modal-container">
        <h4 class="modal-title underline-accent">Add beneficiaries to this distribution</h4>
        <div class="dialog-template">
            <div class="modal-body">
                <p> Please select the beneficiaries from the project <strong> {{actualDistribution.project.name}} </strong>
                    that you want to add to the <strong> {{actualDistribution.name}} </strong> distribution.</p>
                <div class="selectBeneficiaries">
                    <mat-form-field>
                        <mat-select placeholder="Beneficiaries" [formControl]="beneficiaryForm" [(ngModel)]="selectedBeneficiaries" multiple>
                            <mat-option class="options" *ngFor="let beneficiary of beneficiaryList" [value]="beneficiary">{{beneficiary.given_name}}
                                {{beneficiary.family_name}}</mat-option>
                        </mat-select>
                    </mat-form-field>
                </div>
            </div>
            <div class="modal-footer action">
                <button mat-button class="cancel" (click)="exit('Adding canceled')">Cancel</button>
                <button mat-button class="confirm" (click)="confirmAdding()">Confirm</button>
            </div>
        </div>
    </mat-dialog-content>
</ng-template>

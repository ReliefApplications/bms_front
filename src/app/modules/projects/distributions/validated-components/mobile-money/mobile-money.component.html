<div class="container-table">
    <div class="container-content box-primary">
        <div *ngIf="transactionData !== undefined" class="progression">
            <div class="commodities" *ngFor="let commodity of actualDistribution.commodities">
                <h4>{{ commodity.modality_type.name }} {{ TEXT.transaction_progress }} {{ getPercentageValue(commodity) }} % </h4>
                <mat-progress-bar mode="determinate" [value]="getPercentageValue(commodity)"></mat-progress-bar>
                <div class="details">
                    <div class="info_1">
                        <h5>{{TEXT.transaction_amount_total | titlecase}}</h5>
                        {{ getTotalCommodityValue(commodity) }} {{commodity.unit}}
                    </div>

                    <ng-container>
                        <div class="info_2">
                            <h5>{{TEXT.transaction_amount_done | titlecase}}</h5>
                            {{ getAmountSent(commodity) }} {{commodity.unit}}
                        </div>
                        <div class="info_3">
                            <h5>{{TEXT.transaction_amount_waiting | titlecase}}</h5>
                            {{ getReceivedValue(commodity) }} {{commodity.unit}}
                        </div>
                    </ng-container>
                </div>
            </div>
        </div>

        <div class="content-button">
            <div class="action-buttons">
                <button mat-raised-button class="button-background-primary" [matMenuTriggerFor]="menu">
                    <mat-icon>more_vert</mat-icon>
                    <span>{{TEXT.table_actions | titlecase}}</span>
                </button>
                <div class="extension">
                    <mat-menu #menu class="extMenu">
                        <button mat-menu-item (click)="refreshStatuses()">
                            <mat-icon>refresh</mat-icon>
                            <span class="text-button">{{TEXT.transaction_refresh}}</span>
                        </button>
                        <button mat-menu-item *ngIf="hasRights" (click)="requestLogs()">
                            <mat-icon>history</mat-icon>
                            <span class="text-button">{{TEXT.distribution_request_logs}}</span>
                        </button>
                    </mat-menu>
                </div>
                <div class="button-with-extension">
                    <button mat-raised-button class="button-background-primary" (click)="exportTransaction(exportTypeTransaction, 'transactionDistribution')" *ngIf="!loadingExport">
                        <mat-icon>get_app</mat-icon>
                        <span>{{TEXT.export | titlecase}}</span>
                    </button>
                    <mat-spinner [diameter]='25' *ngIf="loadingExport"></mat-spinner>
                    <div class="extension" *ngIf="!loadingExport">
                        <div mat-button class="dropdown" [matMenuTriggerFor]="exportTypeTransaction" [ngClass]="{'arabic':language==='ar'}">
                            <mat-icon>keyboard_arrow_down</mat-icon>
                        </div>
                        <mat-menu #exportTypeTransaction class="extMenu">
                            <button mat-menu-item (click)="extensionType = 'xls'"> .xls <mat-icon *ngIf="extensionType=='xls'">done</mat-icon>
                            </button>
                            <button mat-menu-item (click)="extensionType = 'csv'"> .csv <mat-icon *ngIf="extensionType=='csv'">done</mat-icon>
                            </button>
                            <button mat-menu-item (click)="extensionType = 'ods'"> .ods <mat-icon *ngIf="extensionType=='ods'">done</mat-icon>
                            </button>
                        </mat-menu>
                    </div>
                </div>
            </div>
        </div>

        <div class="waitingDataContainer" *ngIf="loadingTransaction">
            <mat-spinner></mat-spinner>
        </div>

        <div class="content-table" *ngIf="!loadingTransaction">
            <app-transaction-table *ngIf="widthScreen >= maxWidthMobile" [parentObject]="actualDistribution" [entity]="entity" [service]="BeneficiariesService" [data]="transactionData" [editable]="false" [selection]="selection" [checkbox]="true"
                (selectChecked)="getChecked($event)">
            </app-transaction-table>
            <app-transaction-table-mobile *ngIf="widthScreen < maxWidthMobile" [parentObject]="actualDistribution" [entity]="entity" [service]="BeneficiariesService" [data]="transactionData" [editable]="false">
            </app-transaction-table-mobile>
        </div>

        <div class="content-button content-button-footer">
            <div class="action-buttons">
                <mat-spinner [diameter]="35" *ngIf="loaderCache"></mat-spinner>
                <button mat-stroked-button [disabled]="distributionIsStored" *ngIf="!loaderCache" class="button-text-accent" (click)="storeBeneficiaries()">
                    <mat-icon>save</mat-icon>
                    <ng-container *ngIf="distributionIsStored; else distributionIsntStored">
                        {{TEXT.cache_stored_beneficiaries}}
                    </ng-container>
                    <ng-template #distributionIsntStored>
                        {{TEXT.cache_store_beneficiaries}}
                    </ng-template>
                </button>
                <mat-spinner [diameter]="35" *ngIf="transacting"></mat-spinner>
                <button mat-raised-button *ngIf="hasRightsTransaction && !transacting && transactionData" (click)="openDialog(transaction);" class="button-background-accent" [matBadge]="getPeopleCount()" matBadgePosition="before" matBadgeColor="primary">
                    <mat-icon>send</mat-icon> {{TEXT.transaction_transaction}}
                </button>
            </div>
        </div>
    </div>
</div>

<ng-template #transaction>
    <mat-dialog-content class="modal-container">
        <h4 *ngIf="!correctCode" class="modal-title underline-accent stickyHeader">{{TEXT.transaction_confirm}}</h4>
        <h4 *ngIf="correctCode" class="modal-title underline-accent stickyHeader">{{TEXT.transaction_inProgress}}</h4>
        <div class="dialog-template">
            <div class="modal-body" *ngIf="!chartAccepted && !correctCode">
                <p> {{TEXT.transaction_prevention}}</p>
                <div class="lign-container">
                    <mat-checkbox color="primary" [(ngModel)]="chartAccepted" (change)="codeVerif();"></mat-checkbox>
                    <span> {{TEXT.transaction_accept_prevention}} </span>
                </div>
            </div>
            <div class="modal-body" *ngIf="chartAccepted && !correctCode">
                <p> {{TEXT.transaction_email_code}} <br /> {{actualUser.email | titlecase}}. </p>
                <p> {{TEXT.transaction_paste_code}}</p>
                <br />
                <div class="lign-container">
                    <mat-form-field>
                        <input matInput placeholder="Code" [(ngModel)]="enteredCode">
                    </mat-form-field>
                    <button mat-stroked-button class='button-text-primary sendCode-button' (click)='codeVerif()'>{{TEXT.transaction_again}}</button>
                </div>
                <br />
            </div>
            <div class="modal-body progression-bar" *ngIf="correctCode">
                <h4>{{ progression }} %</h4>
                <mat-progress-bar mode="determinate" [value]="progression"></mat-progress-bar>
            </div>
            <div class="modal-button action-buttons stickyFooter" [ngClass]="{'arabic':language==='ar'}">
                <button mat-button class="cancel button-text-accent" (click)="exit('Transaction canceled')" *ngIf="!correctCode">{{TEXT.cancel}}</button>
                <button mat-raised-button class="button-background-accent confirm" [ngClass]="{'disabled': enteredCode.length<6}" (click)="confirmTransaction()" *ngIf="chartAccepted && !correctCode">{{TEXT.transaction_confirm_button}}</button>
            </div>
        </div>
    </mat-dialog-content>
</ng-template>
